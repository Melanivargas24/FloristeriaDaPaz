@model DaPazWebApp.Models.Liquidacion

@{
    ViewData["Title"] = "Registrar Liquidación";
    Layout = "_Layout";
}

<div class="container" style="margin-top:35px; margin-bottom:135px">
    <div class="d-flex justify-between align-items-center encabezado-proveedores">
        <h2>Registrar Liquidación</h2>
    </div>

    @if (ViewBag.Error != null)
    {
        <div class="alert alert-danger">@ViewBag.Error</div>
    }

    <form asp-action="Create" method="post">

        <div class="form-group">
            <label asp-for="IdEmpleado" class="control-label">Empleado <span class="text-danger">*</span></label>
            <select asp-for="IdEmpleado" class="form-control" asp-items="ViewBag.Empleados" id="empleadoSelect">
                <option value="">-- Seleccione un Empleado --</option>
            </select>
            <span asp-validation-for="IdEmpleado" class="text-danger"></span>
        </div>

        <!-- Información del Empleado -->
        <div class="form-group" id="infoEmpleado" style="display: none;">
            <div class="alert alert-info">
                <strong><i class="fas fa-user-circle"></i> Información del Empleado</strong><br>
                <small>
                    <strong>Fecha de Ingreso:</strong> <span id="fechaIngreso">-</span><br>
                    <strong>Años de Servicio:</strong> <span id="antiguedad">-</span> años<br>
                    <strong>Salario por Hora:</strong> ₡<span id="salarioBase">-</span>
                </small>
            </div>
        </div>

        <div class="form-group">
            <label asp-for="FechaLiquidacion" class="control-label">Fecha de Liquidación <span class="text-danger">*</span></label>
            <input asp-for="FechaLiquidacion" type="date" class="form-control" id="FechaLiquidacion" />
            <small class="form-text text-muted">Fecha en que se efectuará la liquidación</small>
            <span asp-validation-for="FechaLiquidacion" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="MontoLiquidacion" class="control-label">Monto de Liquidación <span class="text-danger">*</span></label>
            <input asp-for="MontoLiquidacion" type="number" step="0.01" min="0.01" max="999999999.99" class="form-control" id="MontoLiquidacion" placeholder="Ingrese el monto de la liquidación" />
            <small class="form-text text-muted">Monto total a pagar al empleado</small>
            <span asp-validation-for="MontoLiquidacion" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="Motivo" class="control-label">Motivo de Liquidación (Opcional)</label>
            <textarea asp-for="Motivo" class="form-control" id="Motivo" rows="3" placeholder="Describa el motivo de la liquidación (opcional)"></textarea>
            <small class="form-text text-muted">Este campo es opcional pero recomendado para el historial</small>
            <span asp-validation-for="Motivo" class="text-danger"></span>
        </div>

        <!-- Resumen de Liquidación -->
        <div class="form-group" id="resumenLiquidacion" style="display: none;">
            <div class="alert alert-warning">
                <strong><i class="fas fa-exclamation-triangle"></i> Resumen de Liquidación</strong><br>
                <small>
                    <strong>Empleado:</strong> <span id="empleadoResumen">-</span><br>
                    <strong>Monto Total:</strong> <span id="montoResumen" class="text-danger">-</span><br>
                    <strong>Fecha de Salida:</strong> <span id="fechaResumen">-</span>
                </small>
            </div>
        </div>

        <br />
        
        <div class="alert alert-danger">
            <small><i class="fas fa-exclamation-triangle"></i> <strong>ADVERTENCIA:</strong> La liquidación marcará automáticamente al empleado como INACTIVO. Esta acción NO SE PUEDE DESHACER.</small>
        </div>
        
        <div class="alert alert-info">
            <small><i class="fas fa-info-circle"></i> Los campos marcados con <span class="text-danger">*</span> son obligatorios</small>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-4">
            <button type="submit" class="btn-guardar">Guardar</button>
            <a asp-action="Index" class="btn-cancelar">Cancelar</a>
        </div>
    </form>
</div>

@section Scripts {
    <style>
        .alert-sm {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
        }
        
        .is-invalid {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        .focused {
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
    </style>
    
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function() {
            // Establecer fecha por defecto como hoy
            var today = new Date().toISOString().split('T')[0];
            $('#FechaLiquidacion').val(today);

            // Al cambiar el empleado seleccionado
            $('#empleadoSelect').change(function() {
                var idEmpleado = $(this).val();
                var nombreEmpleado = $(this).find('option:selected').text();

                // Limpiar errores anteriores
                $('.text-danger').text('');
                $('#empleadoSelect').removeClass('is-invalid');

                if (idEmpleado && idEmpleado !== '') {
                    // Obtener información del empleado
                    $.get('@Url.Action("GetEmpleadoSalario", "Liquidacion")', { idEmpleado: idEmpleado })
                        .done(function(data) {
                            if (data && !data.error) {
                                $('#fechaIngreso').text(data.fechaIngreso);
                                $('#antiguedad').text(data.añosTrabajados);
                                $('#salarioBase').text(data.salario.toLocaleString('es-CR', {minimumFractionDigits: 2}));

                                $('#infoEmpleado').show();

                                // Actualizar resumen
                                $('#empleadoResumen').text(nombreEmpleado);
                                actualizarResumen();
                            } else if (data && data.error) {
                                // Mostrar error específico del servidor
                                $('span[data-valmsg-for="IdEmpleado"]').text(data.error);
                                $('#empleadoSelect').addClass('is-invalid');
                                ocultarInformacion();
                            } else {
                                // Respuesta vacía o inválida
                                $('span[data-valmsg-for="IdEmpleado"]').text('No se pudo obtener información del empleado');
                                $('#empleadoSelect').addClass('is-invalid');
                                ocultarInformacion();
                            }
                        })
                        .fail(function(xhr, status, error) {
                            // Error de conexión o servidor
                            $('span[data-valmsg-for="IdEmpleado"]').text('Error al conectar con el servidor: ' + error);
                            $('#empleadoSelect').addClass('is-invalid');
                            ocultarInformacion();
                        });
                } else {
                    // No hay empleado seleccionado
                    ocultarInformacion();
                }
            });

            // Función para ocultar información cuando no hay empleado válido
            function ocultarInformacion() {
                $('#infoEmpleado').hide();
                $('#resumenLiquidacion').hide();
                $('#MontoLiquidacion').val('');
            }

            // Código simplificado - sin sugerencias automáticas

            // Actualizar resumen cuando cambie el monto
            $('#MontoLiquidacion').on('input', function() {
                // Validar que no sea negativo
                var valor = parseFloat($(this).val());
                if (valor < 0 || isNaN(valor)) {
                    $(this).val('');
                }
                actualizarResumen();
            });
            
            // Prevenir entrada de caracteres inválidos en monto
            $('#MontoLiquidacion').on('keydown', function(e) {
                var char = String.fromCharCode(e.which);
                if (char === '-' || char === '+' || char === 'e' || char === 'E') {
                    e.preventDefault();
                    return false;
                }
            });

            // Actualizar resumen cuando cambie la fecha
            $('#FechaLiquidacion').change(function() {
                actualizarResumen();
            });

            function actualizarResumen() {
                var empleado = $('#empleadoSelect').val();
                var monto = $('#MontoLiquidacion').val();
                var fecha = $('#FechaLiquidacion').val();

                if (empleado && monto && fecha) {
                    $('#montoResumen').text('₡' + parseFloat(monto).toLocaleString('es-CR', {minimumFractionDigits: 2}));
                    $('#fechaResumen').text(fecha);
                    $('#resumenLiquidacion').show();
                } else {
                    $('#resumenLiquidacion').hide();
                }
            }

            // Validación y confirmación antes de enviar
            $('form').submit(function(e) {
                var idEmpleado = $('#empleadoSelect').val();
                var empleadoNombre = $('#empleadoSelect option:selected').text();
                var monto = $('#MontoLiquidacion').val();
                var fecha = $('#FechaLiquidacion').val();

                // Validaciones del lado del cliente
                var errores = [];

                if (!idEmpleado || idEmpleado === '' || idEmpleado === '0') {
                    errores.push('Debe seleccionar un empleado');
                    $('#empleadoSelect').addClass('is-invalid');
                }

                if (!monto || parseFloat(monto) <= 0) {
                    errores.push('El monto de liquidación debe ser mayor a 0');
                    $('#MontoLiquidacion').addClass('is-invalid');
                }

                if (monto && parseFloat(monto) > 999999999.99) {
                    errores.push('El monto de liquidación es demasiado alto (máximo: ₡999,999,999.99)');
                    $('#MontoLiquidacion').addClass('is-invalid');
                }

                if (!fecha) {
                    errores.push('Debe seleccionar la fecha de liquidación');
                    $('#FechaLiquidacion').addClass('is-invalid');
                }

                if (errores.length > 0) {
                    e.preventDefault();
                    alert('Por favor corrija los siguientes errores:\n\n• ' + errores.join('\n• '));
                    return false;
                }

                // Si no hay errores, mostrar confirmación
                var confirmMessage = '⚠️ CONFIRMACIÓN DE LIQUIDACIÓN ⚠️\n\n' +
                                   '¿Está COMPLETAMENTE SEGURO de liquidar a:\n' +
                                   'Empleado: ' + empleadoNombre + '\n' +
                                   'Monto: ₡' + parseFloat(monto).toLocaleString('es-CR', {minimumFractionDigits: 2}) + '\n' +
                                   'Fecha de salida: ' + fecha + '\n\n' +
                                   '⚠️ ESTA ACCIÓN NO SE PUEDE DESHACER ⚠️\n' +
                                   'El empleado será marcado como inactivo.\n\n' +
                                   '¿Desea continuar?';

                if (!confirm(confirmMessage)) {
                    e.preventDefault();
                    return false;
                }

                return true;
            });

            // Remover clases de error cuando el usuario corrija los campos
            $('#empleadoSelect, #MontoLiquidacion, #FechaLiquidacion').on('change input', function() {
                $(this).removeClass('is-invalid');
            });

            // Mostrar errores de validación
            if ($('.text-danger').text().trim() !== '') {
                $('.alert-danger').show();
            }

            // Mejorar accesibilidad de campos
            $('.form-control').on('focus', function() {
                $(this).addClass('focused');
            }).on('blur', function() {
                $(this).removeClass('focused');
            });
        });
    </script>
}