@model DaPazWebApp.Models.Vacacion
@{
    ViewData["Title"] = "Registrar Vacación";
    Layout = "_Layout";
}

<div class="container" style="margin-top:35px; margin-bottom:135px">
    <div class="d-flex justify-between align-items-center encabezado-proveedores">
        <h2>Registrar Vacación</h2>
    </div>

    @if (ViewBag.Error != null)
    {
        <div class="alert alert-danger">@ViewBag.Error</div>
    }
    <form asp-action="Create" method="post">

        <div class="form-group">
            <label asp-for="IdEmpleado" class="control-label">Empleado <span class="text-danger">*</span></label>
            <select asp-for="IdEmpleado" class="form-control" asp-items="ViewBag.Empleados" id="empleadoSelect">
                <option value="">-- Seleccione un Empleado --</option>
            </select>
            <span asp-validation-for="IdEmpleado" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="FechaInicio" class="control-label">Fecha de Inicio <span class="text-danger">*</span></label>
            <input asp-for="FechaInicio" type="date" class="form-control" id="fechaInicio" />
            <small class="form-text text-muted">Seleccione la fecha de inicio de la vacación</small>
            <span asp-validation-for="FechaInicio" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="FechaFin" class="control-label">Fecha de Fin <span class="text-danger">*</span></label>
            <input asp-for="FechaFin" type="date" class="form-control" id="fechaFin" />
            <small class="form-text text-muted">Debe ser igual o posterior a fecha de inicio</small>
            <span asp-validation-for="FechaFin" class="text-danger"></span>
        </div>

        <!-- Información de Días Disponibles -->
        <div class="form-group" id="infoVacaciones" style="display: none;">
            <div class="alert alert-secondary">
                <strong><i class="fas fa-calendar-alt"></i> Información de Vacaciones</strong><br>
                <small>
                    <strong>Empleado:</strong> <span id="empleadoSeleccionado">-</span><br>
                    <strong>Año:</strong> <span id="anioVacacion">-</span><br>
                    <strong>Días usados:</strong> <span id="diasUsados">-</span> / 12<br>
                    <strong>Días disponibles:</strong> <span id="diasDisponibles">-</span>
                </small>
            </div>
        </div>

        <!-- Resumen de Vacación -->
        <div class="form-group" id="resumenVacacion" style="display: none;">
            <div class="alert alert-info">
                <strong><i class="fas fa-info-circle"></i> Resumen de Vacación Solicitada</strong><br>
                <small>
                    <strong>Duración:</strong> <span id="duracionVacacion">-</span><br>
                    <strong>Período:</strong> <span id="periodoVacacion">-</span><br>
                    <strong>Estado:</strong> <span id="estadoSolicitud">-</span>
                </small>
            </div>
        </div>

        <br />
        
        <div class="alert alert-info">
            <small><i class="fas fa-info-circle"></i> Los campos marcados con <span class="text-danger">*</span> son obligatorios</small>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-4">
            <button type="submit" class="btn-guardar">Guardar</button>
            <a asp-action="Index" class="btn-cancelar">Cancelar</a>
        </div>
    </form>
</div>

@section Scripts {
    <style>
        .alert-sm {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
        }
        
        .focused {
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
    </style>
    
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function() {
            // Establecer fecha mínima como hoy
            var today = new Date().toISOString().split('T')[0];
            $('#fechaInicio').attr('min', today);

            // Función para calcular días
            function calcularDias() {
                var fechaInicio = $('#fechaInicio').val();
                var fechaFin = $('#fechaFin').val();

                if (fechaInicio && fechaFin) {
                    var inicio = new Date(fechaInicio);
                    var fin = new Date(fechaFin);
                    var diferencia = fin.getTime() - inicio.getTime();
                    var dias = Math.ceil(diferencia / (1000 * 3600 * 24)) + 1;

                    if (dias > 0) {
                        $('#duracionVacacion').text(dias + ' días');
                        $('#periodoVacacion').text(fechaInicio + ' al ' + fechaFin);
                        return dias;
                    }
                }
                $('#duracionVacacion').text('-');
                $('#periodoVacacion').text('-');
                return 0;
            }

            // Función para obtener información de días disponibles
            function obtenerDiasDisponibles() {
                var empleado = $('#empleadoSelect').val();
                var fechaInicio = $('#fechaInicio').val();
                
                if (empleado && fechaInicio) {
                    var anio = new Date(fechaInicio).getFullYear();
                    $('#anioVacacion').text(anio);
                    
                    $.ajax({
                        url: '@Url.Action("ObtenerDiasDisponibles", "Vacacion")',
                        type: 'GET',
                        data: {
                            idEmpleado: empleado,
                            anio: anio
                        },
                        success: function(response) {
                            $('#diasUsados').text(response.diasUsados);
                            $('#diasDisponibles').text(response.diasDisponibles);
                            $('#infoVacaciones').show();
                        },
                        error: function() {
                            console.log('Error al obtener información de días disponibles');
                        }
                    });
                }
            }

            // Función para verificar disponibilidad de fechas
            function verificarDisponibilidad() {
                var empleado = $('#empleadoSelect').val();
                var fechaInicio = $('#fechaInicio').val();
                var fechaFin = $('#fechaFin').val();
                
                // Limpiar alertas anteriores
                $('#alertaDisponibilidad').remove();
                
                if (empleado && fechaInicio && fechaFin) {
                    var dias = calcularDias();
                    
                    $.ajax({
                        url: '@Url.Action("VerificarDisponibilidadFechas", "Vacacion")',
                        type: 'POST',
                        data: {
                            idEmpleado: empleado,
                            fechaInicio: fechaInicio,
                            fechaFin: fechaFin
                        },
                        success: function(response) {
                            // Actualizar información de días disponibles
                            if (response.diasUsados !== undefined) {
                                $('#diasUsados').text(response.diasUsados);
                                $('#diasDisponibles').text(response.diasDisponibles);
                            }
                            
                            if (!response.disponible) {
                                var mensaje = '<div id="alertaDisponibilidad" class="alert alert-danger mt-3"><i class="fas fa-exclamation-triangle"></i> <strong>Solicitud no válida:</strong> ' + response.mensaje;
                                
                                if (response.vacacionesExistentes && response.vacacionesExistentes.length > 0) {
                                    mensaje += '<br><small>Vacaciones existentes: ';
                                    response.vacacionesExistentes.forEach(function(vacacion, index) {
                                        mensaje += (index > 0 ? ', ' : '') + 'Del ' + vacacion.fechaInicio + ' al ' + vacacion.fechaFin;
                                    });
                                    mensaje += '</small>';
                                }
                                mensaje += '</div>';
                                
                                $('#estadoSolicitud').text('❌ No válida').css('color', 'red');
                                $('#resumenVacacion').after(mensaje);
                            } else {
                                $('#estadoSolicitud').text('✅ Válida').css('color', 'green');
                                
                                // Mostrar mensaje de éxito solo si es necesario
                                if (dias <= response.diasDisponibles) {
                                    var mensaje = '<div id="alertaDisponibilidad" class="alert alert-success mt-3"><i class="fas fa-check-circle"></i> <strong>Solicitud válida</strong> - Puede proceder con el registro.</div>';
                                    $('#resumenVacacion').after(mensaje);
                                    
                                    // Ocultar mensaje de éxito después de 3 segundos
                                    setTimeout(function() {
                                        $('#alertaDisponibilidad').fadeOut();
                                    }, 3000);
                                }
                            }
                        },
                        error: function() {
                            var mensaje = '<div id="alertaDisponibilidad" class="alert alert-warning mt-3"><i class="fas fa-exclamation-triangle"></i> Error al verificar disponibilidad. Verifique manualmente.</div>';
                            $('#resumenVacacion').after(mensaje);
                        }
                    });
                }
            }
            
            // Actualizar fecha mínima de fin cuando cambie la fecha de inicio
            $('#fechaInicio').change(function() {
                var fechaInicio = $(this).val();
                if (fechaInicio) {
                    $('#fechaFin').attr('min', fechaInicio);

                    // Si la fecha de fin es anterior, limpiarla
                    var fechaFin = $('#fechaFin').val();
                    if (fechaFin && fechaFin < fechaInicio) {
                        $('#fechaFin').val('');
                    }
                }
                obtenerDiasDisponibles();
                calcularDias();
                mostrarResumen();
                verificarDisponibilidad();
            });

            $('#fechaFin').change(function() {
                calcularDias();
                mostrarResumen();
                verificarDisponibilidad();
            });

            $('#empleadoSelect').change(function() {
                var empleadoTexto = $(this).find('option:selected').text();
                $('#empleadoSeleccionado').text(empleadoTexto);
                obtenerDiasDisponibles();
                mostrarResumen();
                verificarDisponibilidad();
            });

            function mostrarResumen() {
                var empleado = $('#empleadoSelect').val();
                var fechaInicio = $('#fechaInicio').val();
                var fechaFin = $('#fechaFin').val();

                if (empleado && fechaInicio && fechaFin) {
                    $('#resumenVacacion').show();
                } else {
                    $('#resumenVacacion').hide();
                    $('#estadoSolicitud').text('-');
                }
            }

            // Validación del formulario
            $('form').submit(function(e) {
                // Verificar si hay alertas de disponibilidad
                var alertaDisponibilidad = $('#alertaDisponibilidad');
                if (alertaDisponibilidad.length && alertaDisponibilidad.hasClass('alert-danger')) {
                    e.preventDefault();
                    alert('No se puede guardar la vacación porque las fechas seleccionadas se superponen con vacaciones existentes. Por favor seleccione fechas diferentes.');
                    return false;
                }
                
                var empleado = $('#empleadoSelect option:selected').text();
                var dias = calcularDias();

                if (empleado && dias > 0) {
                    var confirmMessage = '¿Confirmar registro de vacación?\n\n' +
                                       'Empleado: ' + empleado + '\n' +
                                       'Duración: ' + dias + ' días\n' +
                                       'Del ' + $('#fechaInicio').val() + ' al ' + $('#fechaFin').val();

                    if (!confirm(confirmMessage)) {
                        e.preventDefault();
                        return false;
                    }
                }
            });

            // Mostrar errores de validación
            if ($('.text-danger').text().trim() !== '') {
                $('.alert-danger').show();
            }

                // Mejorar accesibilidad de campos
            $('.form-control').on('focus', function() {
                $(this).addClass('focused');
            }).on('blur', function() {
                $(this).removeClass('focused');
            });
        });
    </script>
}