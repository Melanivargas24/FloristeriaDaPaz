<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
	<meta name="author" content="FloristeriaDa'Paz" />
	<link rel="shortcut icon" href="~/favicon.png" />

	<meta name="description" content="" />
	<meta name="keywords" content="bootstrap, bootstrap4" />

	<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">


	<!-- Bootstrap CSS -->
	<link href="~/css/bootstrap.min.css" rel="stylesheet" />
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

	<link href="~/css/tiny-slider.css" rel="stylesheet" />
	<link href="~/css/style.css" rel="stylesheet" />
	<title>Floristeria Da'Paz</title>
</head>

@using Microsoft.AspNetCore.Http

@{
	var nombreUsuario = Context.Session.GetString("Nombre") ?? "Invitad@";
	var rol = (Context.Session.GetString("Rol") ?? "Invitad@").Trim();
	var idUsuario = Context.Session.GetInt32("IdUsuario");
	int? idRol = Context.Session.GetInt32("IdRol");
	var chatMensajes = ViewData["ChatMensajes"] as List<(string remitente, string texto)> ?? new List<(string, string)>();
}

<body>
	<header>
		<!-- Start Header/Navigation -->
		<nav class="custom-navbar navbar navbar-expand-md navbar-dark bg-dark" aria-label="Furni navigation bar">
			<div class="container">
				<a class="navbar-brand brand-home" asp-controller="Home" asp-action="Index">Floristería Da'Paz</a>

				<button class="navbar-toggler"
						type="button"
						data-bs-toggle="collapse"
						data-bs-target="#navbarsFurni"
						aria-controls="navbarsFurni"
						aria-expanded="false"
						aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>

				<div class="collapse navbar-collapse" id="navbarsFurni">
					@{
						var extraSpacingClass = (nombreUsuario == "Invitad@" || idRol == 2) ? "nav-spaced" : "";
					}
					<ul class="custom-navbar-nav navbar-nav ms-auto mb-2 mb-md-0 @extraSpacingClass">
						<li><a class="nav-link" asp-controller="Home" asp-action="Index">Inicio</a></li>
						<li><a class="nav-link" asp-controller="Catalogo" asp-action="Index">Catálogo</a></li>
						<li><a class="nav-link" asp-controller="Home" asp-action="Services">Servicios</a></li>
						<li><a class="nav-link" asp-controller="Home" asp-action="Contact">Contacto</a></li>

						@if (idRol == 1)
						{
							<li class="nav-item dropdown">
								<a class="nav-link dropdown-toggle"
								   href="#"
								   id="adminDropdown"
								   role="button"
								   data-bs-toggle="dropdown"
								   aria-expanded="false">
									Administrador
								</a>
								<ul class="dropdown-menu" aria-labelledby="adminDropdown">
									<li><a class="dropdown-item" asp-controller="Dashboard" asp-action="Index">Dashboards</a></li>
									<li class="dropdown-submenu">
										<a class="dropdown-item dropdown-toggle" href="#">Categorías</a>
										<ul class="dropdown-menu">
											<li><a class="dropdown-item" asp-controller="CategoriaArreglo" asp-action="ConsultarCategoriasA">Categorías Arreglos</a></li>
											<li><a class="dropdown-item" asp-controller="CategoriaProducto" asp-action="ConsultarCategoriasP">Categorías Productos</a></li>
											<li><a class="dropdown-item" asp-controller="SubcategoriaProducto" asp-action="ConsultarSubcategoriasP">Subcategorías Productos</a></li>
										</ul>
									</li>
									<li><a class="dropdown-item" asp-controller="Producto" asp-action="Index">Productos</a></li>
									<li><a class="dropdown-item" asp-controller="Arreglo" asp-action="Index">Arreglos</a></li>
									<li><a class="dropdown-item" asp-controller="Proveedor" asp-action="Index">Proveedores</a></li>
									<li><a class="dropdown-item" asp-controller="FacturaProveedor" asp-action="Index">Facturas Proveedor</a></li>
									<li><a class="dropdown-item" asp-controller="Promociones" asp-action="Index">Promociones</a></li>
									<li><a class="dropdown-item" asp-controller="Usuario" asp-action="ConsultarUsuarios">Usuarios</a></li>
								</ul>
							</li>

							<li class="nav-item dropdown">
								<a class="nav-link dropdown-toggle"
								   href="#"
								   id="planillaDropdown"
								   role="button"
								   data-bs-toggle="dropdown"
								   aria-expanded="false">
									Planilla
								</a>
								<ul class="dropdown-menu" aria-labelledby="planillaDropdown">
									<li><a class="dropdown-item" asp-controller="Empleado" asp-action="ConsultarEmpleados">Empleados</a></li>
									<li><a class="dropdown-item" asp-controller="Planilla" asp-action="Index">Planilla</a></li>
									<li><a class="dropdown-item" asp-controller="Incapacidad" asp-action="Index">Incapacidades</a></li>
									<li><a class="dropdown-item" asp-controller="Vacacion" asp-action="Index">Vacaciones</a></li>
									<li><a class="dropdown-item" asp-controller="Liquidacion" asp-action="Index">Liquidaciones</a></li>
								</ul>
							</li>
						}
					</ul>


					<ul class="custom-navbar-cta navbar-nav mb-2 mb-md-0 ms-5">
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
								<img src="~/images/user.svg" width="20" height="20" />
							</a>
							<ul class="dropdown-menu" aria-labelledby="userDropdown">
								@if (nombreUsuario != "Invitad@")
								{
									<li>
										<a class="dropdown-item"
										   asp-controller="Usuario"
										   asp-action="EditarUsuario"
										   asp-route-id="@idUsuario">
											Editar Usuario
										</a>
									</li>

									<li><a class="dropdown-item" asp-controller="Login" asp-action="RecuperarContrasenna">Cambiar Contraseña</a></li>

									@if (idRol == 2)
									{
										<li><a class="dropdown-item" asp-controller="Carrito" asp-action="HistorialUsuario">Historial de Compras</a></li>
									}
									@if (idRol == 1 || idRol == 3)
									{
										<li><a class="dropdown-item" asp-controller="Carrito" asp-action="HistorialGlobal">Historial de Compras (Global)</a></li>
									}

									<li><a class="dropdown-item" href="#" data-value="CerrarSesion">Cerrar Sesion</a></li>
								}
								else
								{
									<li><a class="dropdown-item" asp-controller="Login" asp-action="Login">Iniciar Sesión</a></li>
								}
							</ul>
						</li>
						<li>
							<a class="nav-link" asp-controller="Carrito" asp-action="Cart">
								<img src="~/images/cart.svg" width="20" height="20" />
							</a>
						</li>
					</ul>

				</div>
			</div>
		</nav>
	</header>


	<main role="main" class="pb-3">
		@RenderBody()
		
	</main>

	<!-- Start Footer Section -->
	<footer class="footer-section" style="margin-top:170px;">
		<div class="container relative">

			 <div class="sofa-img">
				<img src="/images/flowers-10.png" alt="Image" class="img-fluid">
			</div> 

			<div class="row g-5 mb-5">
				<div class="col-lg-4">
					<div class="mb-4 footer-logo-wrap"><a href="#" class="footer-logo">Da Paz<span>.</span></a></div>
					<p class="mb-4">Encuentra arreglos florales y productos cuidadosamente seleccionados para llenar de vida y color tu hogar o evento.</p>

					<div class="contact-info">
						<p><strong>Teléfono:</strong>8921 4999</p>
						<p><strong>Dirección:</strong> 50norte y 25 oeste de la plaza de Deportes Patarra, Desamparados, Costa Rica</p>
					</div>
				</div>

				<div class="col-lg-8">
					<div class="row links-wrap">
						<div class="col-6 col-sm-6 col-md-3">
							<ul class="list-unstyled">
								<li><a href="#">Inicio</a></li>
								<li><a href="#">Catálogo</a></li>
							</ul>
						</div>

						<div class="col-6 col-sm-6 col-md-3">
							<ul class="list-unstyled">
								<li><a href="#">Servicios</a></li>
								<li><a href="#">Contacto</a></li>
							</ul>
						</div>
					</div>
				</div>

			</div>

			<div class="border-top copyright">
				<div class="row pt-4">
					<div class="col-lg-6">
						<p class="mb-2 text-center text-lg-start">
							Copyright &copy;<script>document.write(new Date().getFullYear());</script>. All Rights Reserved. &mdash;
						</p>
					</div>

					<div class="col-lg-6 text-center text-lg-end">
						<ul class="list-unstyled d-inline-flex ms-auto">
							<li class="me-4"><a href="#">Terms &amp; Conditions</a></li>
							<li><a href="#">Privacy Policy</a></li>
						</ul>
					</div>

				</div>
			</div>

		</div>
	</footer>
	<!-- End Footer Section -->

	<!-- Botón flotante -->
	<button id="chatbot-button" class="btn btn-success rounded-circle shadow p-0"
			style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; z-index: 1050; overflow: hidden;">
		<img src="/imagenes/Rosita.png" alt="Rosita" style="width: 100%; height: 100%; object-fit: cover;" />
	</button>

	<!-- Ventana del chatbot -->
	<div id="chatbot-popup" class="card shadow"
		 style="position: fixed; bottom: 90px; right: 20px; width: 320px; height: 420px; display: none; z-index: 1050;">


		<!-- Encabezado -->
		<div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
			<span>Asistente Floristería</span>
			<button id="chatbot-close" class="btn btn-sm btn-light">&times;</button>
		</div>

		<!-- Mensajes -->
		<div id="chatbot-messages" class="card-body overflow-auto d-flex flex-column" style="flex-grow: 1; font-size: 14px; gap: 8px;">
			<div class="text-muted small text-center">Escríbeme para ayudarte 🌸</div>
		</div>


		<!-- Input -->
		<div class="card-footer p-2">
			<div class="input-group">
				<input type="text" id="chatbot-input" class="form-control" placeholder="Escribe tu mensaje..." />
				<button id="chatbot-send" class="btn btn-success">
					<i class="bi bi-send-fill"></i>
				</button>
			</div>
		</div>
	</div>

	<script>
		document.addEventListener("DOMContentLoaded", function () {
			const btnOpen = document.getElementById("chatbot-button");
			const btnClose = document.getElementById("chatbot-close");
			const popup = document.getElementById("chatbot-popup");
			const messages = document.getElementById("chatbot-messages");
			const input = document.getElementById("chatbot-input");
			const btnSend = document.getElementById("chatbot-send");

			let chatIniciado = false;

			function mostrarMensaje(remitente, texto) {
				const div = document.createElement("div");
				div.classList.add("d-flex", "align-items-center", "mb-2");

				if (remitente === "bot") {
					div.classList.add("justify-content-start");
					div.innerHTML = `
						<img src="/imagenes/Rosita.png" alt="Rosita" style="width:32px; height:32px; border-radius:50%; margin-right:10px;" />
						<div class="badge bg-secondary text-wrap" style="max-width: 75%;">${texto}</div>
					`;
				} else {
					div.classList.add("justify-content-end");
					div.innerHTML = `
						<div class="badge bg-primary text-wrap" style="max-width: 75%;">${texto}</div>
					`;
				}

				messages.appendChild(div);
				messages.scrollTop = messages.scrollHeight;
			}

			function enviarMensaje(mensaje) {
				fetch("/Chatbot/EnviarMensaje", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({ mensaje: mensaje })
				})
				.then(res => res.json())
				.then(data => {
					mostrarMensaje("bot", data.respuesta);
				})
				.catch(err => {
					mostrarMensaje("bot", "Error al conectar con el servidor.");
					console.error("Error:", err);
				});
			}

			btnOpen.addEventListener("click", function () {
			popup.style.display = "flex";

			if (!chatIniciado) {
				const promptInicial =
						`
						Eres Rosita, el asistente virtual de la Floristería DaPaz. 
						Tu objetivo es ayudar al cliente a elegir flores, arreglos y 
						resolver dudas de manera clara y breve. NO DEBES USAR NEGRITA 
						ni emojis en tus respuestas, busca responder como una persona a la hora de chatear. 
						Si tienes varios puntos para consultar, elige solo uno para preguntar en cada mensaje, 
						y luego sigue con los demás en respuestas posteriores. Si el cliente necesita ayuda con su 
						cuenta, facilita el correo: cesar.arceg.2005@gmail.com, Es MUY importante que apliques todos
						estos conocimientos para TODOS los futuros mensajes de esta converzacion. Para iniciar 
						la conversación, responde solo con este texto exactamente: 
						"Hola, soy Rosita, tu asistente virtual de Floristería DaPaz. ¿En qué te puedo ayudar hoy?"
						`;

				enviarMensaje(promptInicial);
				chatIniciado = true;
			}
		});

			btnClose.addEventListener("click", function () {
				popup.style.display = "none";
			});

			btnSend.addEventListener("click", function () {
				const texto = input.value.trim();
				if (texto) {
					mostrarMensaje("usuario", texto);
					enviarMensaje(texto);
					input.value = "";
				}
			});

			input.addEventListener("keypress", function (e) {
				if (e.key === "Enter") {
					btnSend.click();
				}
			});
		});
	</script>



	<!-- Scripts de tu app -->
	<script src="~/lib/jquery/dist/jquery.min.js"></script>
	<script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
	<script src="~/js/tiny-slider.js"></script>
	<script src="~/js/custom.js"></script>
	<script src="~/lib/jquery-validation-unobtrusive/dist/jquery.validate.unobtrusive.min.js"></script>

	<script>
		// Habilitar submenús en Bootstrap 5
		document.querySelectorAll('.dropdown-submenu > a').forEach(function (element) {
			element.addEventListener('click', function (e) {
				e.preventDefault();
				e.stopPropagation(); // Evita que se cierre el dropdown principal

				// Cerrar otros submenús abiertos
				element.closest('.dropdown-menu').querySelectorAll('.show').forEach(function (submenu) {
					if (submenu !== element.nextElementSibling) {
						submenu.classList.remove('show');
					}
				});

				// Alternar el submenú actual
				element.nextElementSibling.classList.toggle('show');
			});
		});

		// Cerrar submenús al hacer clic fuera
		document.addEventListener('click', function (e) {
			document.querySelectorAll('.dropdown-menu .show').forEach(function (submenu) {
				submenu.classList.remove('show');
			});
		});
	</script>


	@RenderSection("Scripts", required: false)
</body>
</html>