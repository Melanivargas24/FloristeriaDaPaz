
@model DaPazWebApp.Models.CarritoViewModel
@{
    ViewData["Title"] = "Carrito de Compras";
    Layout = "_Layout";
}

<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h2 class="mb-0">Carrito de Compras</h2>
                </div>
                <div class="card-body">
                    @if (TempData["ErrorMensaje"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            @TempData["ErrorMensaje"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }
                    
                    @if (TempData["CarritoMensaje"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            @TempData["CarritoMensaje"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }
                    
                    @if (Model.Items.Count == 0)
                    {
                        <div class="alert alert-info">Tu carrito estÃ¡ vacÃ­o.</div>
                        <a href="/Catalogo/Index" class="btn btn-primary mt-3">Ir al CatÃ¡logo</a>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table align-middle">
                                <thead class="table-light">
                                    <tr>
<th>Imagen</th>
<th>Producto</th>
<th>Precio</th>
<th>Cantidad</th>
<th>Subtotal</th>
<th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
@foreach (var item in Model.Items)
{
    <tr>
        <td style="width:100px">
            <div class="position-relative">
                <img src="@item.Imagen" alt="@item.NombreProducto" class="img-fluid rounded border" style="max-width:80px;max-height:80px;object-fit:contain;">
                @if (item.TienePromocion)
                {
                    <span class="position-absolute top-0 start-0 badge bg-danger small" style="font-size: 0.7rem;">
                        -@item.PorcentajeDescuento.GetValueOrDefault().ToString("F0")%
                    </span>
                }
            </div>
        </td>
        <td>
            <div>
                <span class="fw-bold">@item.NombreProducto</span>
                @if (item.TienePromocion && !string.IsNullOrEmpty(item.NombrePromocion))
                {
                    <br><small class="text-success fw-bold">ðŸŽ‰ @item.NombrePromocion</small>
                }
            </div>
        </td>
        <td>
            @if (item.TienePromocion)
            {
                <div>
                    <span class="text-muted text-decoration-line-through small">â‚¡@item.PrecioOriginal.ToString("N2")</span><br>
                    <span class="text-danger fw-bold">â‚¡@item.PrecioEfectivo.ToString("N2")</span>
                </div>
            }
            else
            {
                <span>â‚¡@item.Precio.ToString("N2")</span>
            }
        </td>
        <td>
            <form method="post" action="/Carrito/ActualizarCantidad" class="d-flex align-items-center" style="gap:4px;">
                @Html.AntiForgeryToken()
                <input type="hidden" name="IdProducto" value="@item.IdProducto" />
                <input type="hidden" name="Tipo" value="@item.Tipo" />
                <input type="number" name="Cantidad" value="@item.Cantidad" min="1" class="form-control form-control-sm" style="width:70px;" />
<button type="submit" style="background: none; border: none; padding: 0;">
    <span class="bi bi-arrow-repeat" style="font-size:1.7rem;"></span>
</button>
            </form>
        </td>
        <td>
            @if (item.TienePromocion)
            {
                <div>
                    <span class="text-muted text-decoration-line-through small">â‚¡@((item.PrecioOriginal * item.Cantidad).ToString("N2"))</span><br>
                    <span class="text-danger fw-bold">â‚¡@((item.PrecioEfectivo * item.Cantidad).ToString("N2"))</span>
                </div>
            }
            else
            {
                <span>â‚¡@((item.Precio * item.Cantidad).ToString("N2"))</span>
            }
        </td>
        <td>
            <form method="post" action="/Carrito/EliminarDelCarrito" style="display:inline;">
                @Html.AntiForgeryToken()
                <input type="hidden" name="IdProducto" value="@item.IdProducto" />
                <input type="hidden" name="Tipo" value="@item.Tipo" />
<button type="submit" style="background: none; border: none; padding: 0;">
    <span class="bi bi-trash" style="font-size:1.7rem;"></span>
</button>
            </form>
        </td>
    </tr>
}
                                </tbody>
                            </table>
                        </div>
<div class="text-end mt-3">
    @if (Model.TotalDescuentos > 0)
    {
        <div class="mb-2">
            <p class="mb-1 text-muted">Subtotal sin descuentos: <span>â‚¡@Model.TotalSinDescuentos.ToString("N2")</span></p>
            <p class="mb-1 text-success fw-bold">Total descuentos aplicados: <span>-â‚¡@Model.TotalDescuentos.ToString("N2")</span></p>
            <hr class="my-2">
        </div>
    }
    <h4>Total: <span class="text-danger">â‚¡@Model.Total.ToString("N2")</span></h4>
    @if (Model.TotalDescuentos > 0)
    {
        <p class="small text-success mb-2">Â¡Has ahorrado â‚¡@Model.TotalDescuentos.ToString("N2") con promociones! ðŸŽ‰</p>
    }
       <a href="/Carrito/Checkout" class="btn-guardar btn-lg mt-2">Proceder al Pago</a>
</div>
                    }
@if (TempData["PedidoConfirmado"] != null)
{
    <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
        @TempData["PedidoConfirmado"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
                </div>
            </div>
        </div>
    </div>
</div>