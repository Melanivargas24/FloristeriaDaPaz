@model DaPazWebApp.Models.UsersModel

@{
    ViewData["Title"] = "Crear Cuenta";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Más ancho -->
            <div class="card shadow rounded-4 register-card">
                <div class="card-header text-center">
                    <h3 class="mb-0">Floristería Da Paz</h3>
                    <p class="mb-0">Crear una nueva cuenta</p>
                </div>
                <div class="card-body">

                    @if (ViewBag.Error != null)
                    {
                        <div class="alert alert-danger" role="alert">
                            @ViewBag.Error
                        </div>
                    }

                    <form asp-action="Signin" method="post" novalidate>
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="nombre" class="form-label">Nombre</label>
                                <input asp-for="nombre" class="form-control" placeholder="Juan" autocomplete="given-name" />
                                <span asp-validation-for="nombre" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="apellido" class="form-label">Apellido</label>
                                <input asp-for="apellido" class="form-control" placeholder="Mora" autocomplete="family-name" />
                                <span asp-validation-for="apellido" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="correo" class="form-label">Correo</label>
                                <div class="position-relative">
                                    <input asp-for="correo" class="form-control" placeholder="correo@ejemplo.com" autocomplete="email" id="correo" />
                                    <div id="correo-loading" class="spinner-border spinner-border-sm position-absolute" style="right: 10px; top: 50%; transform: translateY(-50%); display: none;" role="status">
                                        <span class="visually-hidden">Verificando...</span>
                                    </div>
                                </div>
                                <span asp-validation-for="correo" class="text-danger"></span>
                                <div id="correo-success" class="text-success" style="display: none;">
                                    <i class="fas fa-check-circle"></i> Correo disponible
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="telefono" class="form-label">Teléfono</label>
                                <input asp-for="telefono" class="form-control" placeholder="88884444" autocomplete="tel" pattern="[0-9]*" inputmode="numeric" maxlength="12" oninput="this.value = this.value.replace(/[^0-9]/g, '')" />
                                <span asp-validation-for="telefono" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="contrasena" class="form-label">Contraseña</label>
                                <input asp-for="contrasena" type="password" class="form-control" placeholder="******" autocomplete="new-password" />
                                <span asp-validation-for="contrasena" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row justify-content-center mt-4">
                            <div class="col-auto">
                                <button type="submit" class="btn btn-success">Crear Cuenta</button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="card-footer text-center">
                    ¿Ya tienes cuenta? <a asp-action="Login" class="text-decoration-none">Inicia sesión</a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        $(document).ready(function() {
            var timeoutId;
            
            // Función para verificar correo
            function verificarCorreo() {
                var correo = $('#correo').val();
                var correoSpan = $('span[data-valmsg-for="correo"]');
                var loadingIndicator = $('#correo-loading');
                var successMessage = $('#correo-success');
                
                // Limpiar mensajes previos
                correoSpan.text('');
                correoSpan.removeClass('field-validation-error').addClass('field-validation-valid');
                $('#correo').removeClass('input-validation-error');
                successMessage.hide();
                
                if (correo && correo.length > 0) {
                    // Verificar formato de correo primero
                    var emailRegex = /^[^\\s@@]+@@[^\\s@@]+\\.[^\\s@@]+$/;
                    if (!emailRegex.test(correo)) {
                        correoSpan.text('Debe ingresar un correo válido');
                        correoSpan.removeClass('field-validation-valid').addClass('field-validation-error');
                        $('#correo').addClass('input-validation-error');
                        return;
                    }
                    
                    // Mostrar indicador de carga
                    loadingIndicator.show();
                    
                    // Verificar si el correo ya existe
                    $.ajax({
                        url: '@Url.Action("VerificarCorreoExistente", "Login")',
                        type: 'POST',
                        data: { correo: correo },
                        success: function(response) {
                            loadingIndicator.hide();
                            if (response.existe) {
                                correoSpan.text('Este correo electrónico ya está registrado');
                                correoSpan.removeClass('field-validation-valid').addClass('field-validation-error');
                                $('#correo').addClass('input-validation-error');
                            } else {
                                successMessage.show();
                            }
                        },
                        error: function() {
                            loadingIndicator.hide();
                            // No hacer nada en caso de error de conexión
                        }
                    });
                } else {
                    loadingIndicator.hide();
                }
            }
            
            // Validación de correo duplicado en tiempo real (con retraso)
            $('#correo').on('input', function() {
                clearTimeout(timeoutId);
                $('#correo-success').hide();
                
                timeoutId = setTimeout(function() {
                    verificarCorreo();
                }, 1000); // Esperar 1 segundo después de que el usuario deje de escribir
            });
            
            // Validación inmediata al perder el foco
            $('#correo').on('blur', function() {
                clearTimeout(timeoutId);
                verificarCorreo();
            });
            
            // Validación antes del envío del formulario
            $('form').on('submit', function(e) {
                var correoError = $('span[data-valmsg-for="correo"]').hasClass('field-validation-error');
                if (correoError) {
                    e.preventDefault();
                    return false;
                }
            });
        });
    </script>
}
